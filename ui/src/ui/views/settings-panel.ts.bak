/**
 * Settings panel - a modal overlay containing:
 *   - General
 *   - Config
 *   - Logs
 *   - Debug
 */
import { html, nothing } from "lit";
import type { AppViewState } from "../app-view-state.ts";
import { resolveUiLocale, uiText } from "../i18n.ts";
import type { SettingsTab } from "../navigation.ts";
import { renderThemeToggle } from "../app-render.helpers.ts";
import { icons } from "../icons.ts";
import { AVAILABLE_LOCALES, type Locale } from "./onboarding/i18n.ts";

type SettingsSection = SettingsTab | "general";

const SETTINGS_NAV: Array<{
  id: SettingsSection;
  icon: keyof typeof icons;
}> = [
  { id: "general", icon: "settings" },
  { id: "config", icon: "settings" },
  { id: "logs", icon: "scrollText" },
  { id: "debug", icon: "bug" },
];

function sectionSummary(
  state: AppViewState,
  section: SettingsSection,
): { label: string; description: string } {
  const t = (english: string, chinese: string) => uiText(state.uiLocale, english, chinese);
  switch (section) {
    case "general":
      return {
        label: t("General", "通用"),
        description: t(
          "Personal preferences and language.",
          "外观、语言与基础偏好设置。",
        ),
      };
    case "config":
      return {
        label: t("Config", "配置"),
        description: t(
          "Organized configuration with section-based editing.",
          "按分组管理配置，减少一次性信息压力。",
        ),
      };
    case "logs":
      return {
        label: t("Logs", "日志"),
        description: t(
          "Readable runtime logs for troubleshooting.",
          "更易读的运行日志，方便快速排查问题。",
        ),
      };
    case "debug":
      return {
        label: t("Debug", "调试"),
        description: t(
          "System diagnostics and advanced gateway tools.",
          "系统诊断与高级网关调试工具。",
        ),
      };
    default:
      return { label: section, description: "" };
  }
}

function renderGeneralSection(state: AppViewState) {
  const t = (english: string, chinese: string) => uiText(state.uiLocale, english, chinese);
  const selectedLocale = resolveUiLocale(state.uiLocale);

  const handleLocaleChange = (event: Event) => {
    const select = event.currentTarget as HTMLSelectElement | null;
    if (!select) {
      return;
    }
    const next = resolveUiLocale(select.value);
    state.setUiLocale(next as Locale);
  };

  return html`
    <section class="settings-page settings-page--general">
      <header class="settings-page__header settings-page__header--compact">
        <div>
          <h3 class="settings-page__title">${t("Personalization", "个性化")}</h3>
          <p class="settings-page__desc">
            ${t(
              "Tune appearance and language to match your daily workflow.",
              "调整界面外观和语言，让设置体验更自然。",
            )}
          </p>
        </div>
      </header>

      <div class="settings-surface">
        <h4 class="settings-section__title">${t("Appearance", "外观")}</h4>
        <div class="settings-section__row">
          <div class="settings-section__row-info">
            <span class="settings-section__row-label">${t("Theme", "主题")}</span>
            <span class="settings-section__row-desc">
              ${t(
                "Choose light, dark, or follow your system preference.",
                "可选择浅色、深色或跟随系统外观。",
              )}
            </span>
          </div>
          <div class="settings-section__row-control">
            ${renderThemeToggle(state)}
          </div>
        </div>

        <h4 class="settings-section__title settings-section__title--spaced">
          ${t("Language", "语言")}
        </h4>
        <div class="settings-section__row">
          <div class="settings-section__row-info">
            <span class="settings-section__row-label">${t("System language", "系统语言")}</span>
            <span class="settings-section__row-desc">
              ${t(
                "Uses the same options as onboarding and applies immediately.",
                "与引导页保持一致，切换后立即生效。",
              )}
            </span>
          </div>
          <div class="settings-section__row-control">
            <label class="settings-sr-only" for="settings-system-language">
              ${t("System language", "系统语言")}
            </label>
            <select
              id="settings-system-language"
              class="settings-select"
              .value=${selectedLocale}
              @input=${handleLocaleChange}
              @change=${handleLocaleChange}
            >
              ${AVAILABLE_LOCALES.map(
                (locale) =>
                  html`<option
                    value=${locale.value}
                    ?selected=${locale.value === selectedLocale}
                  >
                    ${locale.nativeLabel} - ${locale.label}
                  </option>`,
              )}
            </select>
          </div>
        </div>
      </div>

      <div class="settings-surface settings-surface--subtle">
        <h4 class="settings-section__title">${t("Resources", "资源")}</h4>
        <a
          class="settings-link"
          href="https://github.com/NJX-njx/opensoul"
          target="_blank"
          rel="noreferrer"
        >
          <span class="settings-link__icon">${icons.link}</span>
          <span class="settings-link__text">${t("GitHub Repository", "GitHub 仓库")}</span>
          <span class="settings-link__external">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" x2="21" y1="14" y2="3"></line>
            </svg>
          </span>
        </a>
      </div>
    </section>
  `;
}

export function renderSettingsPanel(
  state: AppViewState,
  contentSlots: {
    config: unknown;
    logs: unknown;
    debug: unknown;
  },
) {
  if (!state.settingsOpen) {
    return nothing;
  }

  const t = (english: string, chinese: string) => uiText(state.uiLocale, english, chinese);
  const navLabel = (section: SettingsSection) => {
    switch (section) {
      case "general":
        return t("General", "通用");
      case "config":
        return t("Config", "配置");
      case "logs":
        return t("Logs", "日志");
      case "debug":
        return t("Debug", "调试");
      default:
        return section;
    }
  };

  const section = state.settingsSection;
  const sectionMeta = sectionSummary(state, section);

  const handleKeyDown = (event: KeyboardEvent) => {
    if (event.key === "Escape") {
      event.stopPropagation();
      state.closeSettings();
    }
  };

  return html`
    <div class="settings-backdrop" @click=${() => state.closeSettings()}></div>

    <div class="settings-panel" @keydown=${handleKeyDown} tabindex="-1">
      <div class="settings-panel__header">
        <div class="settings-panel__header-main">
          <h2 class="settings-panel__title">${t("Settings", "设置")}</h2>
          <p class="settings-panel__subtitle">${sectionMeta.description}</p>
        </div>
        <div class="settings-panel__header-actions">
          <span class="settings-kbd" aria-hidden="true">Esc</span>
          <button
            class="settings-panel__close"
            @click=${() => state.closeSettings()}
            title=${t("Close settings", "关闭设置")}
            aria-label=${t("Close settings", "关闭设置")}
          >
            ${icons.x}
          </button>
        </div>
      </div>

      <div class="settings-panel__body">
        <nav class="settings-panel__nav">
          ${SETTINGS_NAV.map((item) => {
            const meta = sectionSummary(state, item.id);
            return html`
              <button
                class="settings-nav-item ${section === item.id ? "active" : ""}"
                @click=${() => state.setSettingsSection(item.id)}
                title=${meta.description}
              >
                <span class="settings-nav-item__icon">${icons[item.icon]}</span>
                <span class="settings-nav-item__text">${navLabel(item.id)}</span>
              </button>
            `;
          })}
        </nav>

        <div class="settings-panel__content">
          ${section === "general" ? renderGeneralSection(state) : nothing}
          ${section === "config" ? contentSlots.config : nothing}
          ${section === "logs" ? contentSlots.logs : nothing}
          ${section === "debug" ? contentSlots.debug : nothing}
        </div>
      </div>
    </div>
  `;
}
