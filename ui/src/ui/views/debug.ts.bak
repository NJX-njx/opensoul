import { html, nothing } from "lit";
import { uiText } from "../i18n.ts";
import type { EventLogEntry } from "../app-events.ts";
import { formatEventPayload } from "../presenter.ts";
import type { Locale } from "./onboarding/i18n.ts";

export type DebugProps = {
  locale: Locale;
  loading: boolean;
  status: Record<string, unknown> | null;
  health: Record<string, unknown> | null;
  models: unknown[];
  heartbeat: unknown;
  eventLog: EventLogEntry[];
  callMethod: string;
  callParams: string;
  callResult: string | null;
  callError: string | null;
  onCallMethodChange: (next: string) => void;
  onCallParamsChange: (next: string) => void;
  onRefresh: () => void;
  onCall: () => void;
};

function previewJson(payload: unknown): string {
  try {
    const text = JSON.stringify(payload ?? {}, null, 2);
    if (text.length <= 420) {
      return text;
    }
    return `${text.slice(0, 420)}\n...`;
  } catch {
    return String(payload ?? "");
  }
}

function healthBadgeLabel(health: Record<string, unknown> | null): { tone: string; label: string } {
  const raw = health ? (health as { ok?: unknown }).ok : undefined;
  if (typeof raw === "boolean") {
    return raw ? { tone: "ok", label: "Healthy" } : { tone: "danger", label: "Issue detected" };
  }
  return { tone: "muted", label: "Unknown" };
}

function renderSnapshotCard(params: {
  title: string;
  subtitle: string;
  data: unknown;
  open?: boolean;
  emptyLabel: string;
  rawLabel: string;
}): unknown {
  const hasData = params.data != null;
  return html`
    <details class="debug-snapshot-card" ?open=${Boolean(params.open)}>
      <summary class="debug-snapshot-card__summary">
        <div>
          <div class="debug-snapshot-card__title">${params.title}</div>
          <div class="debug-snapshot-card__sub">${params.subtitle}</div>
        </div>
      </summary>
      <div class="debug-snapshot-card__body">
        ${
          hasData
            ? html`
                <pre class="code-block">${previewJson(params.data)}</pre>
                <details class="debug-nested-details">
                  <summary>${params.rawLabel}</summary>
                  <pre class="code-block">${JSON.stringify(params.data, null, 2)}</pre>
                </details>
              `
            : html`<div class="muted">${params.emptyLabel}</div>`
        }
      </div>
    </details>
  `;
}

export function renderDebug(props: DebugProps) {
  const t = (english: string, chinese: string) => uiText(props.locale, english, chinese);
  const securityAudit =
    props.status && typeof props.status === "object"
      ? (props.status as { securityAudit?: { summary?: Record<string, number> } }).securityAudit
      : null;
  const securitySummary = securityAudit?.summary ?? null;
  const critical = securitySummary?.critical ?? 0;
  const warn = securitySummary?.warn ?? 0;
  const info = securitySummary?.info ?? 0;
  const securityTone = critical > 0 ? "danger" : warn > 0 ? "warn" : "success";
  const securityLabel =
    critical > 0
      ? t(`${critical} critical`, `${critical} 严重问题`)
      : warn > 0
        ? t(`${warn} warnings`, `${warn} 个告警`)
        : t("No critical issues", "无严重问题");

  const health = healthBadgeLabel(props.health);

  return html`
    <section class="settings-page settings-page--debug">
      <header class="settings-page__header">
        <div>
          <h3 class="settings-page__title">${t("Diagnostics", "诊断")}</h3>
          <p class="settings-page__desc">
            ${t(
              "Read high-level runtime signals first, then open raw payloads only when needed.",
              "先看高层诊断信号，再按需展开原始数据，减少调试压力。",
            )}
          </p>
        </div>
      </header>

      <div class="debug-metrics-grid">
        <div class="debug-metric-card">
          <div class="debug-metric-card__label">${t("Models", "模型")}</div>
          <div class="debug-metric-card__value">${props.models.length}</div>
        </div>
        <div class="debug-metric-card">
          <div class="debug-metric-card__label">${t("Captured events", "采集事件")}</div>
          <div class="debug-metric-card__value">${props.eventLog.length}</div>
        </div>
        <div class="debug-metric-card">
          <div class="debug-metric-card__label">${t("Health", "健康状态")}</div>
          <div class="debug-metric-card__value debug-metric-card__value--${health.tone}">${t(health.label, health.label === "Healthy" ? "正常" : health.label === "Issue detected" ? "存在异常" : "未知")}</div>
        </div>
        <div class="debug-metric-card">
          <div class="debug-metric-card__label">${t("Security audit", "安全审计")}</div>
          <div class="debug-metric-card__value debug-metric-card__value--${securityTone}">${securityLabel}</div>
        </div>
      </div>

      ${
        securitySummary
          ? html`<div class="callout ${securityTone} debug-callout">
              ${t("Security audit", "安全审计")}: ${securityLabel}${info > 0 ? ` ・ ${info} ${t("info", "信息")}` : ""}. ${t("Run", "执行")}
              <span class="mono">opensoul security audit --deep</span>
              ${t("for full details.", "获取完整结果。")}
            </div>`
          : nothing
      }

      <section class="settings-surface">
        <div class="settings-surface__head">
          <div>
            <div class="settings-surface__title">${t("Live snapshots", "实时快照")}</div>
            <div class="settings-surface__desc">
              ${t("Status, health, and heartbeat from the gateway.", "来自网关的状态、健康与心跳数据。")}
            </div>
          </div>
          <button class="btn" ?disabled=${props.loading} @click=${props.onRefresh}>
            ${props.loading ? t("Refreshing...", "刷新中...") : t("Refresh", "刷新")}
          </button>
        </div>

        <div class="debug-snapshot-grid">
          ${renderSnapshotCard({
            title: t("Status", "状态"),
            subtitle: t("Gateway runtime status", "网关运行状态"),
            data: props.status,
            open: true,
            emptyLabel: t("No status payload.", "暂无状态数据。"),
            rawLabel: t("View full payload", "查看完整数据"),
          })}
          ${renderSnapshotCard({
            title: t("Health", "健康"),
            subtitle: t("System health checks", "系统健康检查"),
            data: props.health,
            emptyLabel: t("No health payload.", "暂无健康数据。"),
            rawLabel: t("View full payload", "查看完整数据"),
          })}
          ${renderSnapshotCard({
            title: t("Heartbeat", "心跳"),
            subtitle: t("Latest heartbeat event", "最新心跳事件"),
            data: props.heartbeat,
            emptyLabel: t("No heartbeat payload.", "暂无心跳数据。"),
            rawLabel: t("View full payload", "查看完整数据"),
          })}
        </div>
      </section>

      <section class="settings-surface debug-events-shell">
        <div class="settings-surface__head">
          <div>
            <div class="settings-surface__title">${t("Event timeline", "事件时间线")}</div>
            <div class="settings-surface__desc">${t("Latest gateway events.", "最近网关事件。")}</div>
          </div>
        </div>

        ${
          props.eventLog.length === 0
            ? html`<div class="muted">${t("No events yet.", "暂无事件。")}</div>`
            : html`
                <div class="debug-events-list">
                  ${props.eventLog.map(
                    (evt) => html`
                      <details class="debug-event-item">
                        <summary class="debug-event-item__summary">
                          <div class="debug-event-item__main">
                            <div class="debug-event-item__event">${evt.event}</div>
                            <div class="debug-event-item__time">${new Date(evt.ts).toLocaleTimeString()}</div>
                          </div>
                          <div class="debug-event-item__hint">${t("Expand", "展开")}</div>
                        </summary>
                        <pre class="code-block">${formatEventPayload(evt.payload)}</pre>
                      </details>
                    `,
                  )}
                </div>
              `
        }
      </section>

      <details class="settings-surface debug-advanced-shell">
        <summary class="debug-advanced-shell__summary">
          <div>
            <div class="settings-surface__title">${t("Advanced RPC console", "高级 RPC 控制台")}</div>
            <div class="settings-surface__desc">
              ${t(
                "Call raw gateway methods with JSON params.",
                "使用 JSON 参数直接调用网关方法。",
              )}
            </div>
          </div>
        </summary>

        <div class="debug-advanced-shell__body">
          <div class="form-grid" style="margin-top: 16px;">
            <label class="field">
              <span>${t("Method", "方法")}</span>
              <input
                .value=${props.callMethod}
                @input=${(e: Event) => props.onCallMethodChange((e.target as HTMLInputElement).value)}
                placeholder="system-presence"
              />
            </label>
            <label class="field">
              <span>${t("Params (JSON)", "参数（JSON）")}</span>
              <textarea
                .value=${props.callParams}
                @input=${(e: Event) =>
                  props.onCallParamsChange((e.target as HTMLTextAreaElement).value)}
                rows="6"
              ></textarea>
            </label>
          </div>
          <div class="row" style="margin-top: 12px;">
            <button class="btn primary" @click=${props.onCall}>${t("Call", "调用")}</button>
          </div>
          ${
            props.callError
              ? html`<div class="callout danger" style="margin-top: 12px;">${props.callError}</div>`
              : nothing
          }
          ${
            props.callResult
              ? html`<pre class="code-block" style="margin-top: 12px;">${props.callResult}</pre>`
              : nothing
          }
        </div>
      </details>

      <details class="settings-surface debug-models-shell">
        <summary class="debug-models-shell__summary">
          ${t("Model catalog payload", "模型目录数据")} (${props.models.length})
        </summary>
        <pre class="code-block" style="margin-top: 12px;">${JSON.stringify(props.models ?? [], null, 2)}</pre>
      </details>
    </section>
  `;
}
